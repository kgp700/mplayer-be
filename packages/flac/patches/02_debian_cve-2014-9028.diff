From fcf0ba06ae12ccd7c67cee3c8d948df15f946b85 Mon Sep 17 00:00:00 2001
From: Erik de Castro Lopo <erikd@mega-nerd.com>
Date: Wed, 19 Nov 2014 19:35:59 -0800
Subject: [PATCH] src/libFACL/stream_decoder.c : Fail safely to avoid a heap overflow.

A file provided by the reporters caused the stream decoder to write to
un-allocated heap space resulting in a segfault. The solution is to
error out (by returning false from read_residual_partitioned_rice_())
instead of trying to continue to decode.

Fixes: CVE-2014-9028
Reported-by: Michele Spagnuolo,
             Google Security Team <mikispag@google.com>
---
 src/libFLAC/stream_decoder.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff -ur flac-1.3.1.orig/src/libFLAC/stream_decoder.c flac-1.3.1/src/libFLAC/stream_decoder.c
--- flac-1.3.1.orig/src/libFLAC/stream_decoder.c	2014-11-27 03:40:37.344426084 +0100
+++ flac-1.3.1/src/libFLAC/stream_decoder.c	2014-12-02 16:12:08.599363903 +0100
@@ -2376,7 +2376,8 @@
 			decoder->private_->cached = true;
 			send_error_to_client_(decoder, FLAC__STREAM_DECODER_ERROR_STATUS_BAD_HEADER);
 			decoder->protected_->state = FLAC__STREAM_DECODER_SEARCH_FOR_FRAME_SYNC;
-			return true;
+			/* We have received a potentially malicious bt stream. All we can do is error out to avoid a heap overflow. */
+			return false;
 		}
 		decoder->private_->frame.header.number_type = FLAC__FRAME_NUMBER_TYPE_FRAME_NUMBER;
 		decoder->private_->frame.header.number.frame_number = x;
